# Phase 3: çµæœè¡¨ç¤ºãƒ»é›†è¨ˆæ©Ÿèƒ½ - è©³ç´°å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

## ğŸ“Œ Phase 3 ã®ç›®æ¨™
- æŠ•ç¥¨çµæœã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆãƒ»è¡¨ç¤ºæ©Ÿèƒ½ã®å®Ÿè£…
- 1åˆ†ã”ã¨ã®è‡ªå‹•æ›´æ–°æ©Ÿèƒ½
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã¨ã‚°ãƒ©ãƒ•è¡¨ç¤º
- Firestoreã®åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

## ğŸ¯ å®Ÿè£…æ–¹é‡
- **TDD (Test-Driven Development)** ã‚’ç¶™ç¶š
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’é‡è¦–**
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ã‚’å°å…¥ã—ã¦Firestoreã®èª­ã¿å–ã‚Šã‚’æœ€é©åŒ–**

## ğŸ“‹ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: çµæœãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…ï¼ˆ2æ™‚é–“ï¼‰

#### 1.1 ResultServiceã®å®Ÿè£…
**ãƒ†ã‚¹ãƒˆä½œæˆ (TDD First)**
`__tests__/services/resultService.test.ts`
- [ ] å›£ä½“ã”ã¨ã®é›†è¨ˆçµæœå–å¾—ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ãƒ†ã‚¹ãƒˆ
- [ ] çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ãƒ†ã‚¹ãƒˆ
- [ ] çµæœã®æ›´æ–°ãƒ†ã‚¹ãƒˆ

**å®Ÿè£…**
`services/resultService.ts`
```typescript
export class ResultService {
  // å…¨å›£ä½“ã®é›†è¨ˆçµæœã‚’å–å¾—
  static async getAllResults(): Promise<Result[]>
  
  // å›£ä½“åˆ¥ã®é›†è¨ˆçµæœã‚’å–å¾—
  static async getResultByGroup(groupId: string): Promise<Result | null>
  
  // é›†è¨ˆçµæœã‚’æ›´æ–°ï¼ˆç®¡ç†è€…ç”¨ï¼‰
  static async updateResult(groupId: string, data: Partial<Result>): Promise<void>
  
  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—
  static calculateRanking(results: Result[]): Result[]
  
  // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  static async cacheResults(results: Result[]): Promise<void>
}
```

#### 1.2 AggregationServiceã®å®Ÿè£…
**ãƒ†ã‚¹ãƒˆä½œæˆ (TDD First)**
`__tests__/services/aggregationService.test.ts`
- [ ] æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆãƒ†ã‚¹ãƒˆ
- [ ] å¹³å‡ç‚¹è¨ˆç®—ãƒ†ã‚¹ãƒˆ
- [ ] æŠ•ç¥¨æ•°ã‚«ã‚¦ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒãƒƒãƒé›†è¨ˆå‡¦ç†ãƒ†ã‚¹ãƒˆ

**å®Ÿè£…**
`services/aggregationService.ts`
```typescript
export class AggregationService {
  // å…¨å›£ä½“ã®æŠ•ç¥¨ã‚’é›†è¨ˆ
  static async aggregateAllVotes(): Promise<AggregationResult[]>
  
  // ç‰¹å®šå›£ä½“ã®æŠ•ç¥¨ã‚’é›†è¨ˆ
  static async aggregateGroupVotes(groupId: string): Promise<AggregationResult>
  
  // å¹³å‡ç‚¹ã‚’è¨ˆç®—
  static calculateAverageScore(votes: Vote[]): number
  
  // æŠ•ç¥¨æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  static countVotes(votes: Vote[]): number
  
  // ãƒãƒƒãƒé›†è¨ˆå‡¦ç†
  static async batchAggregate(): Promise<void>
}
```

### Step 2: çµæœè¡¨ç¤ºç”¨React Hooksã®å®Ÿè£…ï¼ˆ1.5æ™‚é–“ï¼‰

#### 2.1 ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ä½œæˆ
**ãƒ†ã‚¹ãƒˆä½œæˆ (TDD First)**
`__tests__/hooks/useResults.test.tsx`
- [ ] çµæœãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ†ã‚¹ãƒˆ
- [ ] è‡ªå‹•æ›´æ–°ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- [ ] æ›´æ–°é–“éš”ã®è¨­å®šãƒ†ã‚¹ãƒˆ

**å®Ÿè£…**
`hooks/useResults.ts`
```typescript
export function useResults(updateInterval = 60000) {
  const [results, setResults] = useState<Result[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)
  const [lastUpdated, setLastUpdated] = useState<Date | null>(null)
  const [isUpdating, setIsUpdating] = useState(false)
  
  // çµæœã®å–å¾—
  // è‡ªå‹•æ›´æ–°ã®è¨­å®š
  // æ‰‹å‹•æ›´æ–°
  
  return { results, loading, error, lastUpdated, isUpdating, refetch }
}
```

`hooks/useAggregation.ts`
```typescript
export function useAggregation() {
  const [aggregating, setAggregating] = useState(false)
  const [aggregationResult, setAggregationResult] = useState<AggregationResult | null>(null)
  
  const triggerAggregation = async () => {
    // é›†è¨ˆå‡¦ç†ã‚’ãƒˆãƒªã‚¬ãƒ¼
  }
  
  return { aggregating, aggregationResult, triggerAggregation }
}
```

### Step 3: çµæœè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ2.5æ™‚é–“ï¼‰

#### 3.1 ResultsTableã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
**ãƒ†ã‚¹ãƒˆä½œæˆ (TDD First)**
`__tests__/components/ResultsTable.test.tsx`
- [ ] ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
- [ ] ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- [ ] æ›´æ–°ä¸­è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
- [ ] ç©ºãƒ‡ãƒ¼ã‚¿æ™‚ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆ

**å®Ÿè£…**
`components/ResultsTable.tsx`
```typescript
export function ResultsTable() {
  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
  // æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
}
```

#### 3.2 ResultsChartã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
`components/ResultsChart.tsx`
- [ ] æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤º
- [ ] å††ã‚°ãƒ©ãƒ•è¡¨ç¤º
- [ ] ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.3 UpdateIndicatorã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
`components/UpdateIndicator.tsx`
- [ ] æ¬¡å›æ›´æ–°ã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
- [ ] æ›´æ–°ä¸­è¡¨ç¤º
- [ ] æœ€çµ‚æ›´æ–°æ™‚åˆ»è¡¨ç¤º

### Step 4: çµæœãƒšãƒ¼ã‚¸ã®å®Ÿè£…ï¼ˆ1.5æ™‚é–“ï¼‰

#### 4.1 çµæœãƒšãƒ¼ã‚¸
**å®Ÿè£…**
`app/results/page.tsx`
- [ ] ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ
- [ ] çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã®é…ç½®
- [ ] ã‚°ãƒ©ãƒ•ã®é…ç½®
- [ ] æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®é…ç½®
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### 4.2 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ©Ÿèƒ½
- [ ] 1åˆ†ã”ã¨ã®è‡ªå‹•æ›´æ–°
- [ ] æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³
- [ ] æ›´æ–°ä¸­ã®ã€Œé›†è¨ˆä¸­...ã€è¡¨ç¤º
- [ ] WebSocketã¾ãŸã¯pollingã®å®Ÿè£…

### Step 5: FirestoreåˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆ1æ™‚é–“ï¼‰

#### 5.1 åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ›´æ–°
`scripts/initFirestore.ts`
- [ ] å›£ä½“ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
- [ ] ã‚µãƒ³ãƒ—ãƒ«æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
- [ ] åˆæœŸé›†è¨ˆçµæœã®ä½œæˆ
- [ ] è¨­å®šãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

#### 5.2 ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
- [ ] Firestoreã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ç¢ºèª
- [ ] ã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ

### Step 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ1æ™‚é–“ï¼‰

#### 6.1 Firestoreã‚¯ã‚¨ãƒªæœ€é©åŒ–
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨­å®š
- [ ] ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
- [ ] ãƒãƒƒãƒèª­ã¿å–ã‚Šã®å®Ÿè£…

#### 6.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–
- [ ] React.memoã®ä½¿ç”¨
- [ ] useMemo/useCallbackã®é©åˆ‡ãªä½¿ç”¨
- [ ] ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®é˜²æ­¢

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆ
- ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®å…¨ãƒ¡ã‚½ãƒƒãƒ‰
- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®å‹•ä½œ
- é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯

### çµ±åˆãƒ†ã‚¹ãƒˆ
- Firestoreã¨ã®é€£æº
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®å‹•ä½œ
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®çµæœè¡¨ç¤ºãƒ•ãƒ­ãƒ¼

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®è¡¨ç¤ºé€Ÿåº¦
- æ›´æ–°é¢‘åº¦ã®è² è·ãƒ†ã‚¹ãƒˆ

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
form-live/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ resultService.ts
â”‚   â”œâ”€â”€ aggregationService.ts
â”‚   â””â”€â”€ cacheService.ts
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useResults.ts
â”‚   â”œâ”€â”€ useAggregation.ts
â”‚   â””â”€â”€ useAutoUpdate.ts
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ResultsTable.tsx
â”‚   â”œâ”€â”€ ResultsChart.tsx
â”‚   â”œâ”€â”€ UpdateIndicator.tsx
â”‚   â””â”€â”€ RankingCard.tsx
â”œâ”€â”€ app/
â”‚   â””â”€â”€ results/
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ initFirestore.ts
â””â”€â”€ __tests__/
    â”œâ”€â”€ services/
    â”œâ”€â”€ hooks/
    â””â”€â”€ components/
```

## â±ï¸ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

### Day 1ï¼ˆ6æ™‚é–“ï¼‰
- **åˆå‰ï¼ˆ3æ™‚é–“ï¼‰**
  - Step 1: çµæœãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ2æ™‚é–“ï¼‰
  - Step 2: React Hooksã®å‰åŠï¼ˆ1æ™‚é–“ï¼‰
- **åˆå¾Œï¼ˆ3æ™‚é–“ï¼‰**
  - Step 2: React Hooksã®å¾ŒåŠï¼ˆ0.5æ™‚é–“ï¼‰
  - Step 3: çµæœè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ2.5æ™‚é–“ï¼‰

### Day 2ï¼ˆ3.5æ™‚é–“ï¼‰
- **åˆå‰ï¼ˆ2æ™‚é–“ï¼‰**
  - Step 4: çµæœãƒšãƒ¼ã‚¸ã®å®Ÿè£…ï¼ˆ1.5æ™‚é–“ï¼‰
  - Step 5: FirestoreåˆæœŸãƒ‡ãƒ¼ã‚¿ã®å‰åŠï¼ˆ0.5æ™‚é–“ï¼‰
- **åˆå¾Œï¼ˆ1.5æ™‚é–“ï¼‰**
  - Step 5: FirestoreåˆæœŸãƒ‡ãƒ¼ã‚¿ã®å¾ŒåŠï¼ˆ0.5æ™‚é–“ï¼‰
  - Step 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ1æ™‚é–“ï¼‰

**åˆè¨ˆ: ç´„9.5æ™‚é–“ï¼ˆ1.5æ—¥ï¼‰**

## âœ… å®Œäº†æ¡ä»¶

### æ©Ÿèƒ½è¦ä»¶
- [ ] æŠ•ç¥¨çµæœãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹
- [ ] ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ›´æ–°ä¸­ã¯ã€Œé›†è¨ˆä¸­...ã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚°ãƒ©ãƒ•è¡¨ç¤ºãŒæ©Ÿèƒ½ã™ã‚‹

### éæ©Ÿèƒ½è¦ä»¶
- [ ] æ›´æ–°å‡¦ç†ãŒ1ç§’ä»¥å†…ã«å®Œäº†
- [ ] 100å›£ä½“ã¾ã§ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- [ ] ãƒ¢ãƒã‚¤ãƒ«ã§ã®å¿«é©ãªé–²è¦§
- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£åŸºæº–ã®æº–æ‹ 

### ãƒ†ã‚¹ãƒˆè¦ä»¶
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
- [ ] E2Eãƒ†ã‚¹ãƒˆã§ä¸»è¦ãƒ•ãƒ­ãƒ¼ãŒé€šã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®åˆæ ¼

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **ãƒãƒ£ãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
```bash
npm install recharts
```

2. **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‹ã‚‰é–‹å§‹**
```bash
mkdir -p __tests__/services
touch __tests__/services/resultService.test.ts
touch __tests__/services/aggregationService.test.ts
```

3. **Firestoreã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š**
- Firebase Consoleã§è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
- `votes` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: groupId + createdAt
- `results` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: rank + updatedAt

## ğŸ“ æ³¨æ„äº‹é …

1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**
   - Firestoreã®onSnapshotã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€pollingã‚’ä½¿ç”¨ã™ã‚‹ã‹æ¤œè¨
   - ã‚³ã‚¹ãƒˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
   - resultsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ä½¿ç”¨
   - ç›´æ¥votesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ãªã„

3. **é›†è¨ˆå‡¦ç†**
   - Cloud Functionsã§ã®å®Ÿè£…ã‚‚æ¤œè¨ï¼ˆPhase 4ã§å®Ÿè£…äºˆå®šï¼‰
   - ç¾æ™‚ç‚¹ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®é›†è¨ˆã‚’å®Ÿè£…

4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - å¤§é‡ã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã§ã‚‚å¿«é©ã«å‹•ä½œã™ã‚‹ã‚ˆã†æœ€é©åŒ–
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã‚‚æ¤œè¨

## ğŸ¯ Phase 4 ã¸ã®å±•æœ›

- ç®¡ç†è€…æ©Ÿèƒ½ã®å®Ÿè£…
- Firebase Authenticationã®å°å…¥
- Cloud Functionsã§ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é›†è¨ˆ
- Security Rulesã®é©åˆ‡ãªè¨­å®š
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
