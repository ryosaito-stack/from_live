# 📑 リアルタイム投票集計システム 要件定義書  
（Firestore + Next.js + 集計キャッシュ版）

---

## 1. システム概要
- 投票データを **Firebase Firestore** に保存。  
- **Next.js** をフロントエンドとして利用し、投票フォーム・集計画面・管理画面を提供。  
- スマホブラウザから匿名で投票可能。  
- 投票は **端末ごとに1団体1回まで**。  
- 集計結果は **Cloud Functions または Firestoreトリガーで1分ごとに更新**し、`results` コレクションに保存。  
- ユーザー画面は **1分ごとに`results`を取得し、更新時は「集計中…」を表示**。  

---

## 2. 利用者
- **投票ユーザー**：スマホから団体に投票し、結果を確認。  
- **管理者**：団体の管理、対象団体切り替え、投票履歴の確認、集計確認を行う。  

---

## 3. 機能要件

### 3.1 投票機能
- 団体リストをFirestoreから取得してプルダウン表示。  
- 点数入力（例：1〜5点）。  
- 投票送信時に端末ID（localStorageに保存したUUID）を付与してFirestoreに保存。  
- **同じ団体 + 同じ端末ID** の投票が既に存在する場合は再投票不可。  

### 3.2 集計機能
- Firestoreの `votes` コレクションをもとに、1分ごとに集計処理を実行。  
- 集計結果は `results` コレクションに保存（団体ごとの合計点・順位を保持）。  
- ユーザー画面は `results` から最新結果を取得して表示。  
- 更新中は「集計中…」のメッセージを表示。  

### 3.3 表示機能（ユーザー画面）
- 投票フォーム画面  
- 集計結果画面（団体別ランキング）  
- 1分ごとに `results` を取得し、UIを更新  
- レスポンシブ対応  

### 3.4 管理者画面
- 投票履歴（`votes`）の一覧・検索  
- 集計結果（`results`）の確認  
- 団体一覧（`groups`）の編集（追加・削除）  
- 設定（`config`）で対象団体を変更可能  

---

## 4. 非機能要件
- **対応端末**：スマートフォン（iOS/Androidブラウザ）  
- **パフォーマンス**：投票から集計反映まで最大1分  
- **リアルタイム性**：1分ごとに更新  
- **セキュリティ**：  
  - 投票は匿名可、端末IDで制御  
  - 管理画面は Firebase Authentication で管理者のみアクセス可能  
  - Firestore Security Rulesで不正アクセス防止  

---

## 5. データ構造（Firestore設計）

### コレクション: `votes`（投票履歴）
| フィールド   | 型         | 例               |
|--------------|------------|------------------|
| groupId      | string     | 団体A            |
| score        | number     | 5                |
| deviceId     | string     | device-xyz123    |
| createdAt    | timestamp  | 2025-09-15T10:32 |

### コレクション: `groups`（団体一覧）
| フィールド   | 型     | 例    |
|--------------|--------|-------|
| name         | string | 団体A |

### コレクション: `results`（集計結果・キャッシュ）
| フィールド   | 型     | 例    |
|--------------|--------|-------|
| groupId      | string | 団体A |
| totalScore   | number | 42    |
| rank         | number | 1     |
| updatedAt    | timestamp | 2025-09-15T10:33 |

### コレクション: `config`（設定）
| フィールド   | 型     | 例    |
|--------------|--------|-------|
| currentGroup | string | 団体A |

---

## 6. 運用フロー
1. ユーザーがスマホから投票フォームにアクセス。  
2. 初回アクセス時に端末IDを発行し、localStorageに保存。  
3. 投票データをFirestore `votes` に保存。  
4. Cloud Functions が1分ごとに `votes` を集計 → `results` に反映。  
5. ユーザー画面は1分ごとに `results` を取得してランキングを更新。  
6. 更新中は「集計中…」を表示。  
7. 管理者は管理画面で履歴・団体一覧・設定を操作可能。  

---

## 7. 拡張要件（将来）
- 更新間隔を動的に調整（例：5秒更新/1分更新の切替）。  
- 投票制限（1日1票/期間限定）。  
- BigQuery連携による詳細分析。  
- グラフ可視化（Chart.js, Recharts）。  
